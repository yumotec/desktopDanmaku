name: PR Compile Test

on:
  pull_request:
    branches: [ main, master, develop ]

jobs:
  compile-test:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [64, 32]          # 目标架构
        debug: [0, 1]            # 0 = Release, 1 = Debug
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 设置代码页为 UTF-8，避免中文输出乱码
      - name: Set code page to UTF-8
        run: chcp 65001
        shell: cmd

      # 安装 MSYS2 并配置 MinGW-w64 工具链（包含 g++、windres 等）
      - name: Setup MSYS2 and install MinGW toolchains
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64        # 初始环境，不影响后续安装
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-i686-gcc
            # 以下包可选，但 windres 已包含在 gcc 依赖中
            mingw-w64-x86_64-binutils
            mingw-w64-i686-binutils

      # 下载并安装 GNU make 4.4.1（来自 ezwinports），添加重试机制
      - name: Download and install GNU make 4.4.1
        run: |
          $makeUrl = "https://sourceforge.net/projects/ezwinports/files/make-4.4.1-without-guile-w32-bin.zip/download"
          $zipPath = "$env:TEMP\make-4.4.1.zip"
          $extractPath = "$env:RUNNER_TEMP\make-4.4.1"
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
          
          # 添加重试机制，最多尝试 3 次
          $retryCount = 0
          $maxRetries = 3
          $success = $false
          
          while ($retryCount -lt $maxRetries -and !$success) {
            try {
              Write-Host "下载 GNU make 4.4.1 (尝试 $($retryCount + 1)/$maxRetries)..."
              Invoke-WebRequest -Uri $makeUrl -OutFile $zipPath -MaximumRetryCount 3 -RetryIntervalSec 5
              $success = $true
              Write-Host "下载成功！"
            } catch {
              $retryCount++
              Write-Host "下载失败，错误：$($_.Exception.Message)"
              if ($retryCount -lt $maxRetries) {
                Write-Host "等待 5 秒后重试..."
                Start-Sleep -Seconds 5
              }
            }
          }
          
          if (!$success) {
            Write-Error "下载 GNU make 失败，已尝试 $maxRetries 次"
            exit 1
          }
          
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          # 将 make.exe 所在目录添加到 GITHUB_PATH，供后续步骤使用
          echo "$extractPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh

      # 验证 make 版本是否符合要求
      - name: Verify make version
        run: make --version | findstr "4.4.1"
        shell: cmd

      # 根据当前矩阵中的架构，设置对应的 MinGW bin 目录为环境变量
      # 动态检测 MSYS2 安装路径，避免硬编码路径问题
      - name: Set MinGW path for this architecture
        run: |
          # 检测 MSYS2 安装路径
          $msys2Path = "C:\msys64"
          if (!(Test-Path $msys2Path)) {
            # 尝试其他可能的安装路径
            $possiblePaths = @("D:\msys64", "E:\msys64", "C:\tools\msys64")
            foreach ($path in $possiblePaths) {
              if (Test-Path $path) {
                $msys2Path = $path
                break
              }
            }
          }
          
          # 设置 MINGW_PATH 环境变量
          $mingwArch = ${{ matrix.arch }}
          $mingwPath = "$msys2Path\mingw$mingwArch\bin"
          
          # 验证路径是否存在
          if (!(Test-Path $mingwPath)) {
            Write-Error "MinGW 路径不存在：$mingwPath"
            exit 1
          }
          
          Write-Host "设置 MinGW 路径为：$mingwPath"
          echo "MINGW_PATH=$mingwPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      # 验证 g++ 和 windres 是否可用
      - name: Verify compiler and resource compiler
        run: |
          set PATH=%MINGW_PATH%;%PATH%
          g++ --version
          windres --version
        shell: cmd

      # 执行编译测试
      - name: Compile ${{ matrix.arch }}-bit ${{ matrix.debug == 0 && 'Release' || 'Debug' }}
        run: |
          set PATH=%MINGW_PATH%;%PATH%
          make ARCH=${{ matrix.arch }} DEBUG=${{ matrix.debug }}
        shell: cmd

      # 上传构建产物（可选，用于调试）
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: danmaku-${{ matrix.arch }}bit-${{ matrix.debug == 0 && 'release' || 'debug' }}
          path: build/${{ matrix.arch }}/${{ matrix.debug == 0 && 'release' || 'debug' }}/danmaku.exe
          retention-days: 7